---
- name: Enable universe repository x86
  apt_repository:
    repo: deb http://archive.ubuntu.com/ubuntu focal universe
    state: present
    update_cache: True
  when: not ansible_architecture is search("arm")

# Not necessary?
# - name: Enable universe repository rasberry pi ARM
#   apt_repository:
#     repo: deb http://ports.ubuntu.com/ubuntu-ports focal universe
#     state: absent
#   when: ansible_architecture is search("arm")

- name: Install Prerequisite Packages
  apt:
    package: "{{ apt_prerequisites }}"
    state: present
    update_cache: True

- name: Set Timezone PHP Debian
  lineinfile:
    path: "{{ item }}"
    regexp: "date.timezone"
    line: "date.timezone = {{ time_zone }}"
  with_items:
    - /etc/php/{{ php_version }}/fpm/php.ini
    - /etc/php/{{ php_version }}/cli/php.ini

- name: Configure MariaDB Debian
  lineinfile:
    path: /etc/mysql/mariadb.conf.d/50-server.cnf
    insertafter: "^[mysqld]"
    line: |
      innodb_file_per_table=1
      lower_case_table_names=0

# - name: Prepare MariaDB on remote host
#   script: scripts/mysql_setup.sh {{ mysql_password }} {{ poller_ip }}
- name: Create Logins for MariaDB On Poller
  become: True
  community.mysql.mysql_user:
    name: librenms
    host: "{{ poller_ip }}"
    password: "{{ mysql_password }}"
    priv: "librenms.*:ALL"
    login_host: localhost
    login_user: root
    login_password: ""
    state: present

- name: Start and enable MariaDB Service
  service:
    name: mariadb
    state: restarted
    enabled: True

- name: Copy www.conf to librenms.conf
  copy:
    remote_src: True
    src: /etc/php/{{ php_version }}/fpm/pool.d/www.conf
    dest: /etc/php/{{ php_version }}/fpm/pool.d/librenms.conf

- name: Change PHP-FPM www to librenms
  lineinfile:
    path: /etc/php/{{ php_version }}/fpm/pool.d/librenms.conf
    regex: '\[www\]'
    line: "[librenms]"

- name: Update PHP-FPM user to librenms
  lineinfile:
    path: /etc/php/{{ php_version }}/fpm/pool.d/librenms.conf
    regex: '^user\ ='
    line: "user = librenms"

- name: Update PHP-FPM group to librenms
  lineinfile:
    path: /etc/php/{{ php_version }}/fpm/pool.d/librenms.conf
    regex: '^group\ ='
    line: "group = librenms"

- name: Update listen to a unique name
  lineinfile:
    path: /etc/php/{{ php_version }}/fpm/pool.d/librenms.conf
    regex: '^listen\ ='
    line: "listen = /run/php-fpm-librenms.sock"
